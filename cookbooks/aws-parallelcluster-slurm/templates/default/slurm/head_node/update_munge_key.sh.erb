#!/bin/bash
# This script updates the munge key used in the system.
# It fetches the key from AWS Secrets Manager or generates one if it doesn't exist.
# The script does not require any argument.
#
# Usage: ./update_munge_key.sh
# #
function share_munge_key {
    local shared_directory=$1
    echo "Sharing munge key to ${shared_directory}"
    mkdir -p ${shared_directory}/.munge
    cp /etc/munge/munge.key ${shared_directory}/.munge/.munge.key
    chmod 0600 ${shared_directory}/.munge
    chmod 0600 ${shared_directory}/.munge/.munge.key
}

set -e

MUNGE_KEY_FILE="/etc/munge/munge.key"
SECRET_ARN="<%= @munge_key_secret_arn %>"
REGION="<%= @region %>"
MUNGE_USER="<%= @munge_user %>"
MUNGE_GROUP="<%= @munge_group %>"
SHARED_DIRECTORY="<%= @shared_directory %>"
SHARED_DIRECTORY_LOGIN="<%= @shared_directory_login %>"

# If SECRET_ARN is provided, fetch the munge key from Secrets Manager
if [ -n "${SECRET_ARN}" ]; then
  echo "Fetching munge key from AWS Secrets Manager: ${SECRET_ARN}"
  encoded_key=$(aws secretsmanager get-secret-value --secret-id ${SECRET_ARN} --query 'SecretString' --output text --region ${REGION})

  if [ -z "${encoded_key}" ]; then
    echo "Error fetching munge key from Secrets Manager or the key is empty"
    exit 1
  fi

  # Decode munge key and write to munge.key file
  decoded_key=$(echo $encoded_key | base64 -d)
  if [ $? -ne 0 ]; then
    echo "Error decoding the munge key with base64"
    exit 1
  fi

  # Check munge key size
  key_size=$(echo "${decoded_key}" | wc -c)
  if [ $key_size -lt 32 ] || [ $key_size -gt 1024 ]; then
    echo "Fetched munge key size is out of valid range [256-8192 bits]."
    exit 1
  fi

  echo "${decoded_key}" > ${MUNGE_KEY_FILE}

  # Set ownership on the key
  chown ${MUNGE_USER}:${MUNGE_GROUP} ${MUNGE_KEY_FILE}
  # Enforce correct permission on the key
  chmod 0600 ${MUNGE_KEY_FILE}

else
  echo "MUNGE KEY SECRET ARN isn't provided"
  exit 1
fi

# Enable and restart munge service
systemctl enable munge
echo "Restarting munge service"
systemctl restart munge

# Wait for a short period
sleep 5

# Check if munge service is running
if systemctl --quiet is-active munge; then
  echo "Munge service is active"
else
  echo "Failed to restart munge service"
  exit 1
fi

# Share munge key
echo "Sharing munge key"
mkdir -p ${SHARED_DIRECTORY}/.munge
cp /etc/munge/munge.key ${SHARED_DIRECTORY}/.munge/.munge.key
chmod 0600 ${SHARED_DIRECTORY}/.munge
chmod 0600 ${SHARED_DIRECTORY}/.munge/.munge.key

mkdir -p ${SHARED_DIRECTORY_LOGIN}/.munge
cp /etc/munge/munge.key ${SHARED_DIRECTORY_LOGIN}/.munge/.munge.key
chmod 0600 ${SHARED_DIRECTORY_LOGIN}/.munge
chmod 0600 ${SHARED_DIRECTORY_LOGIN}/.munge/.munge.key
echo "Shared munge key"

exit 0
