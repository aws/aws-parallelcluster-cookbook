#!/bin/bash
# This script checks whether there are running login nodes in a specified AWS ParallelCluster stack and login nodes pool.
# It first retrieves the ARN of the Load Balancer associated with the specified stack and login nodes pool.
# If a Load Balancer is found, it then retrieves the ARN of the Target Group associated with the Load Balancer.
# Lastly, it checks the health of the targets in the Target Group to determine the number of healthy and unhealthy login nodes.
# If there are any healthy or unhealthy nodes found, it concludes that there are running login nodes.
#
# Usage: ./check_if_has_running_login_nodes.sh

STACK_NAME="<%= @stack_name %>"
LOGIN_NODES_POOL_NAME="<%= @login_nodes_pool_name %>"
REGION="<%= @region %>"

# Check if LOGIN_NODES_POOL_NAME is empty
if [[ -z "${LOGIN_NODES_POOL_NAME}" ]]; then
    echo "No LoginNodes are specified. Please refer to ParallelCluster official documentation for more information."
    exit 0
fi

# Get Target Group ARN associated with the Load Balancer
target_group_arn=$(aws elbv2 describe-target-groups \
    --names "${STACK_NAME}-${LOGIN_NODES_POOL_NAME}-TargetGroup" \
    --query "TargetGroups[0].TargetGroupArn" \
    --output text \
    --region ${REGION})

# Exit if Target Group is not found
if [[ -n "${target_group_arn}" ]]; then
    echo "TargetGroup ARN found: ${target_group_arn}"
else
    echo "No Target Group found for the specified stack and login nodes pool."
    exit 1
fi

# Get the number of healthy and unhealthy targets
target_healths=$(aws elbv2 describe-target-health \
    --target-group-arn $target_group_arn \
    --region ${REGION})

healthy_count=$(echo $target_healths | jq -r '.TargetHealthDescriptions[] | select(.TargetHealth.State == "healthy") | .Target.Id' | wc -l)
unhealthy_count=$(echo $target_healths | jq -r '.TargetHealthDescriptions[] | select(.TargetHealth.State != "healthy") | .Target.Id' | wc -l)

# Check if there are running login nodes
total_nodes=$((healthy_count + unhealthy_count))
if [[ $total_nodes -gt 0 ]]; then
    echo "Login nodes are running."
else
    echo "Login nodes are stopped."
fi
