#!/bin/bash
set -ex
env

# Root does not need SSH key generation
[ ${USER} == "root" ] && exit 0

# Skip SSH key creation if the SSH has been already configured for the user.
# We assume that SSH has been already configured if the directory .ssh already exists in the user home.
user_ssh_dir="${HOME}/.ssh"
[ -d "${user_ssh_dir}" ] && exit 0

mkdir -m 0700 "${user_ssh_dir}"

ssh-keygen -q -t rsa -f "${user_ssh_dir}/id_rsa" -N ''
cat "${user_ssh_dir}/id_rsa.pub" >> "${user_ssh_dir}/authorized_keys"
chmod 0600 "${user_ssh_dir}/authorized_keys"
ssh-keyscan <%=  node['hostname'] %> > "${user_ssh_dir}/known_hosts"
chmod 0600 "${user_ssh_dir}/known_hosts"
chown ${USER}:$(id -g ${USER}) -R "${user_ssh_dir}"
