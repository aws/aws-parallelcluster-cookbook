# Allows to test single resources.
#
# Must be run as local file (override) of kitchen.docker.yml
# export KITCHEN_YAML=kitchen.docker.yml
# export KITCHEN_LOCAL_YAML=kitchen.resources.yml
# See: https://kitchen.ci/docs/reference/configuration
---
verifier:
  name: inspec
  inspec_tests:
    # resource tests will use controls from this directory
    - path: test/resources


suites:
# This is the result of the ERB block below
#  - name: package_repos
#    run_list:
#      - recipe[aws-parallelcluster::test_resource]
#    verifier:
#      controls:
#        - package_repos
#    attributes:
#      cluster:
#        base_os: alinux2
#      resource: package_repos

# If you need to test a resource with an action or properties different from the default ones,
# add custom tests here and adjust `aws-parallelcluster-test::test_resource`
# to allow `action` and/or `properties` parameters.

# If you need to test a resource with recipe/resources dependencies,
# add recipe[aws-parallelcluster::add_dependencies] as first item in the run_list
# then define a dependencies attribute, listing them with recipe: or resource: prefix.
# You can find an example in the add_depdendencies.rb file.

<% [
  'package_repos',
  ].each do |resource| %>
  - name: <%= resource %>
    run_list:
      # This is a test recipe executing the default action of the resource you pass as `resource` attribute,
      # with default properties
      - recipe[aws-parallelcluster::test_resource]
    verifier:
      controls:
        - <%= resource %>
    attributes:
      resource: <%= resource %>
<%end %>
  - name: c_states
    run_list:
      - recipe[aws-parallelcluster-install::test_resource]
    verifier:
      controls:
        - c_states_kernel_configuration
    attributes:
      resource: c_states
  - name: ec2_udev_rules
    run_list:
      - recipe[aws-parallelcluster-install::test_resource]
    verifier:
      controls:
        - write_common_udev_configuration_files
        - ec2blkdev_service_installation
        - debian_udevd_reload_configuration
    attributes:
      resource: ec2_udev_rules
  - name: mysql_client
    run_list:
      - recipe[aws-parallelcluster::add_dependencies]
      - recipe[aws-parallelcluster-install::test_resource]
    verifier:
      controls:
        - mysql_client_installed
        - mysql_client_source_node_created
    attributes:
      dependencies:
        - recipe:aws-parallelcluster::test_dummy
        - recipe:aws-parallelcluster-install::directories
      resource: mysql_client
  - name: nfs
    run_list:
      - recipe[aws-parallelcluster-install::test_resource]
    verifier:
      controls:
        - nfs_installed_with_right_version
    attributes:
      resource: nfs
      dependencies:
        - recipe:aws-parallelcluster-test::docker_mock
