#!/bin/bash
set -e

. /etc/parallelcluster/cfnconfig

# Notify compute is ready
instance_id_url="http://169.254.169.254/latest/meta-data/instance-id"
instance_id=$(curl --retry 3 --retry-delay 0 --silent --fail ${instance_id_url})
instance_type_url="http://169.254.169.254/latest/meta-data/instance-type"
instance_type=$(curl --retry 3 --retry-delay 0 --silent --fail ${instance_type_url})
local_hostname_url="http://169.254.169.254/latest/meta-data/local-hostname"
local_hostname=$(curl --retry 3 --retry-delay 0 --silent --fail ${local_hostname_url})
num_sockets=$(lscpu | grep 'Socket(s):')
num_sockets=($num_sockets)
num_sockets=${num_sockets[1]}
threads_per_core=$(lscpu | grep 'Thread(s) per core:')
threads_per_core=($threads_per_core)
threads_per_core=${threads_per_core[3]}
cores_per_socket=$(lscpu | grep 'Core(s) per socket:')
cores_per_socket=($cores_per_socket)
cores_per_socket=${cores_per_socket[3]}
real_mem=$(cat /proc/meminfo | grep "MemTotal:")
real_mem=($real_mem)
real_mem=${real_mem[1]}
<%= node['cfncluster']['cookbook_virtualenv_path'] %>/bin/aws --region ${cfn_region} sqs send-message --queue-url ${cfn_sqs_queue} --message-body '{"Type" : "Notification", "Message" : "{\"StatusCode\":\"Complete\",\"Description\":\"Succesfully launched '${instance_id}'\",\"Event\":\"parallelcluster:COMPUTE_READY\",\"EC2InstanceId\":\"'${instance_id}'\",\"Slots\":\"'${cfn_instance_slots}'\",\"LocalHostname\":\"'${local_hostname}'\",\"EC2InstanceType\":\"'${instance_type}'\",\"Sockets\":\"'${num_sockets}'\",\"ThreadsPerCore\":\"'${threads_per_core}'\",\"CoresPerSocket\":\"'${cores_per_socket}'\",\"RealMemory\":\"'${real_mem}'\"}"}'
